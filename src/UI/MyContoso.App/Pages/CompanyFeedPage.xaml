<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:fs="clr-namespace:FlagstoneUI.Core.Controls;assembly=FlagstoneUI.Core"
             xmlns:vm="clr-namespace:MyContoso.App.ViewModels"
             xmlns:shared="clr-namespace:Shared;assembly=Shared"
             xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:lucide="clr-namespace:Plugin.Maui.Lucide.Controls;assembly=Plugin.Maui.Lucide"
             xmlns:li="clr-namespace:Plugin.Maui.Lucide;assembly=Plugin.Maui.Lucide"
             x:Class="MyContoso.App.Pages.CompanyFeedPage"
             x:DataType="vm:CompanyFeedViewModel"
             Title="Company Feed"
             BackgroundColor="{DynamicResource Color.Background}">
    
    <Grid RowDefinitions="Auto,*">
        <!-- Page Header -->
        <VerticalStackLayout Grid.Row="0"
                            Padding="16,16,16,8"
                            Spacing="10"
                            BackgroundColor="{DynamicResource Color.Background}">
            <Label Text="Company Feed"
                   TextColor="{DynamicResource Color.OnBackground}"
                   FontSize="24"
                   FontAttributes="Bold"
                   FontFamily="{OnPlatform iOS='OpenSansBold'}"/>
            <Label Text="Stay connected with the latest updates and conversations"
                   TextColor="{DynamicResource Color.OnSurfaceVariant}"
                   FontSize="Header"
                   Margin="0,4,0,0" />
        </VerticalStackLayout>
        
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Updates}"
                           SelectionMode="None"
                           ItemsUpdatingScrollMode="KeepScrollOffset">
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       Spacing="16">
                        <Label Text="No updates available"
                               TextColor="{DynamicResource Color.OnSurface}"
                               FontSize="16"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="shared:CompanyUpdate">
                        <!-- TODO: Extract this to a control -->
                        <fs:FsCard Style="{DynamicResource ElevatedCard}">
                            <fs:FsCard.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CompanyFeedViewModel}}, Path=ViewUpdateCommand}"
                                                    CommandParameter="{Binding .}" />
                            </fs:FsCard.GestureRecognizers>
                            
                            <VerticalStackLayout Spacing="20">
                                <!-- Author Row with Avatar -->
                                <Grid ColumnDefinitions="40,*" ColumnSpacing="12">
                                    <!-- Avatar Circle with Author Initials -->
                                    <mct:AvatarView Grid.Column="0"
                                                    WidthRequest="40"
                                                    HeightRequest="40"
                                                    CornerRadius="20"
                                                    Padding="0"
                                                    BackgroundColor="{DynamicResource Color.Primary}"
                                                    BorderColor="Transparent"
                                                    Text="{Binding Author, Converter={StaticResource InitialsConverter}}"
                                                    TextColor="{DynamicResource Color.OnPrimary}"
                                                    FontSize="14"
                                                    FontAttributes="Bold"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                    
                                    <!-- Author Info -->
                                    <VerticalStackLayout Grid.Column="1" 
                                                        VerticalOptions="Center"
                                                        Spacing="2">
                                        <Label Text="{Binding Author}"
                                               TextColor="{DynamicResource Color.OnSurface}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               FontFamily="{OnPlatform iOS='OpenSansBold'}"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="{Binding PublishedDate, StringFormat='{0:MMM dd, yyyy}'}"
                                               TextColor="{DynamicResource Color.OnSurfaceVariant}"
                                               FontSize="12" />
                                    </VerticalStackLayout>
                                </Grid>
                                
                                <!-- Content -->
                                <VerticalStackLayout Spacing="8"
                                                     Margin="0,30,0,0">
                                    <Label Text="{Binding Title}"
                                           TextColor="{DynamicResource Color.OnSurface}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           FontFamily="{OnPlatform iOS='OpenSansBold'}"
                                           LineBreakMode="WordWrap" />
                                    
                                    <Label Text="{Binding Body}"
                                           TextColor="{DynamicResource Color.OnSurfaceVariant}"
                                           FontSize="14"
                                           MaxLines="5"
                                           LineBreakMode="TailTruncation"
                                           LineHeight="1.2" />
                                </VerticalStackLayout>
                                
                                <!-- Action Buttons -->
                                <BoxView HeightRequest="1"
                                         BackgroundColor="{DynamicResource Color.OutlineVariant}"
                                         Margin="0,4,0,0" />
                                
                                <FlexLayout Direction="Row"
                                            JustifyContent="SpaceAround">
                                    <Border StrokeShape="RoundRectangle 15"
                                            Margin="0"
                                            Padding="0"
                                            Stroke="Transparent"
                                            BackgroundColor="{Binding IsLiked, Converter={StaticResource LikedToColorConverter}}">
                                        <HorizontalStackLayout Spacing="0"
                                                               Margin="6"
                                                               Padding="0"
                                                               HorizontalOptions="Center">
                                            <lucide:Icon Name="{DynamicResource Heart}"
                                                         Color="{AppThemeBinding Light={StaticResource Color.Primary},
                                                                                                      Dark={StaticResource Color.Primary.Dark}}"
                                                         Margin="0"
                                                         HorizontalOptions="Center"
                                                         Size="14"/>
                                            <fs:FsButton Text="{Binding Likes}"
                                                         Style="{DynamicResource TextButton}"
                                                         FontSize="14"
                                                         HeightRequest="20"
                                                         HorizontalOptions="Center"/>    
                                        </HorizontalStackLayout>
                                    </Border>
                                    
                                    <HorizontalStackLayout Spacing="0"
                                                           Margin="6"
                                                           Padding="0"
                                                           HorizontalOptions="Center">
                                        <lucide:Icon Name="{DynamicResource MessageCircle}"
                                                     Color="{AppThemeBinding Light={StaticResource Color.Primary},
                                                                                                      Dark={StaticResource Color.Primary.Dark}}"
                                                     Margin="0"
                                                     HorizontalOptions="Center"
                                                     Size="14"/>
                                        <fs:FsButton Text="{Binding Comments}"
                                                     Style="{DynamicResource TextButton}"
                                                     FontSize="14"
                                                     HeightRequest="20"
                                                     HorizontalOptions="Center"
                                                     Margin="0"/>    
                                    </HorizontalStackLayout>
                                    
                                    <HorizontalStackLayout Spacing="0"
                                                           Margin="6"
                                                           Padding="0"
                                                           HorizontalOptions="Center">
                                        <lucide:Icon Name="{x:Static li:Icons.Share2}"
                                                     Color="{AppThemeBinding Light={StaticResource Color.Primary},
                                                                                                      Dark={StaticResource Color.Primary.Dark}}"
                                                     Margin="0"
                                                     Size="14"
                                                     HorizontalOptions="Center"/>
                                        <fs:FsButton Text="Share"
                                                     Style="{DynamicResource TextButton}"
                                                     FontSize="14"
                                                     HeightRequest="20"
                                                     Margin="0"
                                                     HorizontalOptions="Center"/>
                                    </HorizontalStackLayout>
                                </FlexLayout>
                            </VerticalStackLayout>
                        </fs:FsCard>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
        
        <ActivityIndicator Grid.Row="1"
                         IsRunning="{Binding IsLoading}"
                         IsVisible="{Binding IsLoading}"
                         Color="{DynamicResource Color.Primary}"
                         HorizontalOptions="Center"
                         VerticalOptions="Center" />
    </Grid>
</ContentPage>
